<template>
  <div class="min-h-screen bg-zinc-50 dark:bg-zinc-950">
    <div class="container mx-auto px-4 py-6 space-y-8">
      <!-- Meeting Hero Section -->
      <MeetingHero 
        :meeting="meeting" 
        :main-institution="mainInstitution"
        :agenda-items="meeting.agenda_items"
        @edit="showMeetingModal = true"
        @show-delete-dialog="showDeleteDialog = true"
      />
      
      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
        <!-- Agenda Items (Main Content) -->
        <div class="xl:col-span-2">
          <SortableCardContainer 
            :items="meeting.agenda_items" 
            :meeting-id="meeting.id"
            :show-vote-options="showVoteOptions"
            @add="showAgendaItemStoreModal = true"
            @edit="handleAgendaClick"
            @delete="handleAgendaItemDelete"
            @update:show-vote-options="showVoteOptions = $event"
          />
        </div>
        
        <!-- Secondary Content Sidebar -->
        <div class="xl:col-span-1">
          <SecondaryContentSection 
            :meeting="meeting"
            @open-file-manager="currentTab = 'Failai'"
            @open-task-manager="currentTab = 'Užduotys'"
          />
        </div>
      </div>
      
      <!-- Legacy Content Areas (Hidden/Modal) -->
      <div v-if="currentTab === 'Failai'" class="mt-8">
        <Card>
          <CardHeader>
            <CardTitle class="flex items-center gap-2">
              <FileText class="h-5 w-5" />
              {{ $t('Failų valdymas') }}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <FileManager 
              :starting-path="meeting.sharepointPath"
              :fileable="{ ...meeting, type: 'Meeting' }" 
            />
          </CardContent>
        </Card>
      </div>
      
      <div v-if="currentTab === 'Užduotys'" class="mt-8">
        <Card>
          <CardHeader>
            <CardTitle class="flex items-center gap-2">
              <CheckSquare class="h-5 w-5" />
              {{ $t('Užduočių valdymas') }}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <TaskManager 
              :taskable="{ id: meeting.id, type: 'App\\Models\\Meeting' }"
              :tasks="meeting.tasks" 
            />
          </CardContent>
        </Card>
      </div>
    </div>
    
    <!-- Modals -->
    <Dialog v-model:open="showMeetingModal">
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{{ $t("Redaguoti posėdžio datą") }}</DialogTitle>
        </DialogHeader>
        <Suspense>
          <MeetingForm class="mt-2" :meeting="meeting" @submit="handleMeetingFormSubmit" />
        </Suspense>
      </DialogContent>
    </Dialog>
    
    <Dialog v-model:open="showAgendaItemStoreModal">
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{{ $t("Pridėti darbotvarkės punktus") }}</DialogTitle>
        </DialogHeader>
        <AgendaItemsForm class="w-full" :loading @submit="handleAgendaItemsFormSubmit" />
      </DialogContent>
    </Dialog>
    
    <Dialog v-model:open="showAgendaItemUpdateModal">
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{{ $t("Redaguoti darbotvarkės punktą") }}</DialogTitle>
        </DialogHeader>
        <AgendaItemForm v-if="selectedAgendaItem" :agenda-item="selectedAgendaItem" @submit="handleAgendaItemUpdate" />
      </DialogContent>
    </Dialog>
    
    <!-- Delete Confirmation Dialog -->
    <Dialog v-model:open="showDeleteDialog">
      <DialogContent class="max-w-md">
        <DialogHeader>
          <DialogTitle class="flex items-center gap-2 text-destructive">
            <AlertTriangle class="h-5 w-5" />
            {{ $t("Šalinti posėdį?") }}
          </DialogTitle>
        </DialogHeader>
        
        <div class="space-y-4">
          <p class="text-sm text-zinc-600 dark:text-zinc-400">
            {{ $t("Ar tikrai norite ištrinti šį posėdį? Šis veiksmas negrįžtamas ir bus pašalinti visi su posėdžiu susiję duomenys, įskaitant darbotvarkės punktus.") }}
          </p>
          
          <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 rounded-lg p-3">
            <p class="text-sm text-red-800 dark:text-red-300 font-medium">
              {{ $t("Bus ištrinta:") }}
            </p>
            <ul class="text-xs text-red-700 dark:text-red-400 mt-1 space-y-1">
              <li>• {{ meeting.agenda_items.length }} {{ $t("darbotvarkės punktai") }}</li>
              <li v-if="meeting.tasks && meeting.tasks.length">• {{ meeting.tasks.length }} {{ $t("užduotys") }}</li>
              <li v-if="meeting.files && meeting.files.length">• {{ meeting.files.length }} {{ $t("failai") }}</li>
            </ul>
          </div>
          
          <div class="flex justify-end gap-3">
            <Button variant="outline" @click="showDeleteDialog = false">
              {{ $t("Atšaukti") }}
            </Button>
            <Button variant="destructive" @click="handleMeetingDelete">
              <Trash2 class="h-4 w-4 mr-2" />
              {{ $t("Šalinti posėdį") }}
            </Button>
          </div>
        </div>
      </DialogContent>
    </Dialog>
  </div>
</template>

<script setup lang="tsx">
import { ref, computed } from "vue";
import { router, useForm } from "@inertiajs/vue3";
import { useStorage } from "@vueuse/core";
import { trans as $t } from "laravel-vue-i18n";
import { formatStaticTime } from "@/Utils/IntlTime";
import { genitivizeEveryWord } from "@/Utils/String";
import Icons from "@/Types/Icons/filled";
import { BreadcrumbHelpers, usePageBreadcrumbs } from "@/Composables/useBreadcrumbsUnified";

// UI Components
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/Components/ui/dialog";
import { Card, CardContent, CardHeader, CardTitle } from "@/Components/ui/card";

// Custom Components
import MeetingHero from "@/Components/Meetings/MeetingHero.vue";
import SortableCardContainer from "@/Components/AgendaItems/SortableCardContainer.vue";
import SecondaryContentSection from "@/Components/Meetings/SecondaryContentSection.vue";
import AgendaItemForm from "@/Components/AdminForms/AgendaItemForm.vue";
import AgendaItemsForm from "@/Components/AdminForms/Special/AgendaItemsForm.vue";
import MeetingForm from "@/Components/AdminForms/MeetingForm.vue";
import FileManager from "@/Features/Admin/SharepointFileManager/Viewer/FileManager.vue";
import TaskManager from "@/Features/Admin/TaskManager/TaskManager.vue";

// Icons
import { FileText, CheckSquare, AlertTriangle, Trash2 } from 'lucide-vue-next';

const props = defineProps<{
  meeting: App.Entities.Meeting;
}>();

// Component state
const showMeetingModal = ref(false);
const showAgendaItemStoreModal = ref(false);
const showAgendaItemUpdateModal = ref(false);
const showDeleteDialog = ref(false);
const currentTab = useStorage("show-meeting-tab", "");
const showVoteOptions = useStorage("show-vote-options", false);
const loading = ref(false);

// Form handling
const meetingAgendaForm = useForm({
  meeting: props.meeting.id,
  agendaItems: [],
});

const selectedAgendaItem = ref<App.Entities.AgendaItem | null>(null);

// Computed values
const mainInstitution: App.Entities.Institution | string =
  props.meeting.institutions?.[0] ?? "Be institucijos";

const meetingTitle = computed(() => {
  if (props.meeting.title && props.meeting.title !== "") {
    return props.meeting.title;
  }
  
  const institutionName = typeof mainInstitution === 'string' 
    ? mainInstitution 
    : mainInstitution.name;
    
  return `${formatStaticTime(new Date(props.meeting.start_time), {
    year: "numeric",
    month: "long",
    day: "numeric",
  })} ${genitivizeEveryWord(institutionName)} posėdis`;
});

// Generate breadcrumbs automatically with new simplified API
usePageBreadcrumbs(() => {
  if (typeof mainInstitution === 'string') {
    return [
      { label: mainInstitution, icon: Icons.INSTITUTION },
      { label: meetingTitle.value, icon: Icons.MEETING }
    ];
  }
  
  return BreadcrumbHelpers.adminShow(
    mainInstitution.name,
    "institutions.show", 
    { institution: mainInstitution.id },
    meetingTitle.value,
    Icons.INSTITUTION,
    Icons.MEETING
  );
});

// Event handlers
const handleMeetingFormSubmit = (meeting: App.Entities.Meeting) => {
  router.patch(route("meetings.update", props.meeting.id), meeting, {
    onSuccess: () => {
      showMeetingModal.value = false;
    },
  });
};

const handleAgendaClick = (agendaItem: App.Entities.AgendaItem) => {
  selectedAgendaItem.value = agendaItem;
  showAgendaItemUpdateModal.value = true;
};

const handleAgendaItemDelete = (agendaItem: App.Entities.AgendaItem) => {
  router.delete(route("agendaItems.destroy", agendaItem.id));
};

const handleAgendaItemUpdate = (agendaItem: App.Entities.AgendaItem) => {
  router.patch(route("agendaItems.update", agendaItem.id), agendaItem, {
    onSuccess: () => {
      showAgendaItemUpdateModal.value = false;
    },
  });
};

const handleAgendaItemsFormSubmit = (agendaItems: Record<string, any>) => {
  loading.value = true;

  meetingAgendaForm
    .transform((data) => ({
      meeting_id: props.meeting.id,
      ...agendaItems,
    }))
    .post(route("agendaItems.store"), {
      onSuccess: () => {
        meetingAgendaForm.reset();
        showAgendaItemStoreModal.value = false;
      },
      onFinish: () => {
        loading.value = false;
      },
    });
};

const handleMeetingDelete = () => {
  const redirectTo = typeof mainInstitution === 'string' 
    ? route('admin.dashboard')
    : route('institutions.show', mainInstitution.id);
    
  router.delete(route("meetings.destroy", props.meeting.id), { 
    data: { redirect_to: redirectTo },
    onSuccess: () => {
      showDeleteDialog.value = false;
    }
  });
};
</script>
