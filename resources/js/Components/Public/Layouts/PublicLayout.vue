<template>
  <FadeTransition>
    <Suspense>
      <NConfigProvider
        v-show="mounted"
        :theme="isThemeDark ? darkTheme : undefined"
        :theme-overrides="themeOverrides"
      >
        <div
          class="flex min-h-screen flex-col justify-between bg-neutral-50 antialiased dark:bg-zinc-900"
        >
          <FadeTransition appear
            ><MainNavigation :is-theme-dark="isThemeDark"
          /></FadeTransition>
          <main class="pt-24 pb-8">
            <slot></slot>
          </main>

          <FadeTransition appear>
            <ConsentCard
              v-if="!cookieConsent"
              @okay-cookie-consent="cookieConsent = true"
            />
          </FadeTransition>

          <Footer />
        </div>

        <!-- preconnect to tawk.to -->
        <link rel="preconnect" href="https://embed.tawk.to" />
      </NConfigProvider>
      <template #fallback>
        <div class="flex h-screen items-center justify-center">
          <NSpin>
            <template #description>
              <div class="mt-2 h-8 text-vusa-red">
                <FadeTransition>
                  <span v-if="spinWarning">
                    Pabandykite perkrauti puslapį arba grįžkite į
                    <a class="underline" :href="$page.props.app.url">vusa.lt</a>
                  </span>
                  <span v-else></span>
                </FadeTransition>
              </div>
            </template>
          </NSpin>
        </div>
      </template>
    </Suspense>
  </FadeTransition>
</template>

<script setup lang="ts">
import { NSpin, darkTheme } from "naive-ui";
import { defineAsyncComponent, onMounted, ref } from "vue";
import { isDarkMode, updateDarkMode } from "@/Composables/darkMode";
import { useStorage } from "@vueuse/core";

import FadeTransition from "@/Components/Transitions/FadeTransition.vue";

const isThemeDark = ref<boolean>(isDarkMode());
const mounted = ref(false);
const spinWarning = ref(false);

const themeOverrides = {
  common: {
    primaryColor: "#bd2835FF",
    primaryColorHover: "#CD3543FF",
    primaryColorPressed: "#CC2130FF",
    primaryColorSuppl: "#B93945FF",
  },
};

const ConsentCard = defineAsyncComponent(
  () => import("@/Components/Public/ConsentCard.vue")
);

const NConfigProvider = defineAsyncComponent(() =>
  import("naive-ui").then((m) => m.NConfigProvider)
);

const MainNavigation = defineAsyncComponent(
  () => import("@/Components/Public/Layouts/MainNavigation.vue")
);

const Footer = defineAsyncComponent(
  () => import("@/Components/Public/FullWidth/SiteFooter.vue")
);

const cookieConsent = useStorage("cookie-consent", false);

updateDarkMode(isThemeDark);

onMounted(() => {
  mounted.value = true;

  // UserWay
  (function (d) {
    let s = d.createElement("script");
    s.setAttribute("data-account", "5OC3pQZI6r");
    s.setAttribute("src", "https://cdn.userway.org/widget.js");
    (d.body || d.head).appendChild(s);
  })(document);

  var Tawk_API = Tawk_API || {},
    Tawk_LoadStart = new Date();

  (function () {
    let s1 = document.createElement("script"),
      s0 = document.getElementsByTagName("script")[0];
    s1.async = true;
    s1.src = "https://embed.tawk.to/5f71b135f0e7167d00145612/default";
    s1.charset = "UTF-8";
    s1.setAttribute("crossorigin", "*");
    s0.parentNode?.insertBefore(s1, s0);
  })();
  // usetimeout to delay the spin description
  setTimeout(() => {
    spinWarning.value = true;
  }, 5000);
});
</script>
