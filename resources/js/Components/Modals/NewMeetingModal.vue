<template>
  <Dialog :open="showModal" @update:open="handleDialogClose">
    <DialogContent class="sm:max-w-5xl max-h-[90vh] overflow-y-auto p-6 md:p-8 pt-8">
      <DialogHeader class="relative">
        <DialogTitle class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <component :is="Icons.MEETING" class="h-5 w-5" />
            {{ $t('Sukurti susitikimą') }}
          </div>
        </DialogTitle>
        <DialogDescription>
          {{ $t('Sukurkite susitikimą su visa darbotvarkę ir papildoma informacija') }}
        </DialogDescription>
      </DialogHeader>

      <div class="flex flex-col gap-6 lg:flex-row">
        <!-- Stepper -->
        <div class="lg:w-80 lg:border-r border-border lg:pr-6">
          <div class="space-y-4">
            <div class="flex items-center justify-between text-sm text-muted-foreground mb-2">
              <span>{{ $t('Naujausias žingsnis') }}</span>
              <span>{{ meetingCreation.state.currentStep }}/{{ totalSteps }}</span>
            </div>

            <div class="space-y-6">
              <!-- Step 1 -->
              <div class="flex items-start gap-3 cursor-pointer" @click="handleStepClick(1)">
                <div :class="[
                  'flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all',
                  meetingCreation.state.currentStep === 1
                    ? 'bg-primary border-primary text-primary-foreground'
                    : meetingCreation.state.currentStep > 1
                      ? 'bg-green-100 border-green-500 text-green-600 dark:bg-green-900 dark:text-green-400'
                      : 'border-muted-foreground/30 text-muted-foreground'
                ]">
                  <CheckCircle v-if="meetingCreation.state.currentStep > 1" class="h-4 w-4" />
                  <component :is="Icons.INSTITUTION" v-else class="h-4 w-4" />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 :class="[
                    'font-medium text-sm',
                    meetingCreation.state.currentStep === 1 ? 'text-primary' : ''
                  ]">
                    {{ $t('Pasirinkite instituciją') }}
                  </h3>
                  <p v-if="meetingCreation.state.institution?.name" class="text-xs text-muted-foreground truncate">
                    {{ meetingCreation.state.institution?.name }}
                  </p>
                </div>
              </div>

              <!-- Step 2 -->
              <div class="flex items-start gap-3 cursor-pointer" @click="handleStepClick(2)">
                <div :class="[
                  'flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all',
                  meetingCreation.state.currentStep === 2
                    ? 'bg-primary border-primary text-primary-foreground'
                    : meetingCreation.state.currentStep > 2
                      ? 'bg-green-100 border-green-500 text-green-600 dark:bg-green-900 dark:text-green-400'
                      : 'border-muted-foreground/30 text-muted-foreground'
                ]">
                  <CheckCircle v-if="meetingCreation.state.currentStep > 2" class="h-4 w-4" />
                  <component :is="Icons.MEETING" v-else class="h-4 w-4" />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 :class="[
                    'font-medium text-sm',
                    meetingCreation.state.currentStep === 2 ? 'text-primary' : ''
                  ]">
                    {{ $t('Susitikimo detalės') }}
                  </h3>
                  <p v-if="formatMeetingTime()" class="text-xs text-muted-foreground truncate">
                    {{ formatMeetingTime() }}
                  </p>
                  <p v-if="getMeetingTypeName()" class="text-xs text-muted-foreground truncate">
                    {{ getMeetingTypeName() }}
                  </p>
                </div>
              </div>

              <!-- Step 3 -->
              <div v-if="!isQuickMode" class="flex items-start gap-3 cursor-pointer" @click="handleStepClick(3)">
                <div :class="[
                  'flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all',
                  meetingCreation.state.currentStep === 3
                    ? 'bg-primary border-primary text-primary-foreground'
                    : meetingCreation.state.currentStep > 3
                      ? 'bg-green-100 border-green-500 text-green-600 dark:bg-green-900 dark:text-green-400'
                      : 'border-muted-foreground/30 text-muted-foreground'
                ]">
                  <CheckCircle v-if="meetingCreation.state.currentStep > 3" class="h-4 w-4" />
                  <component :is="Icons.AGENDA_ITEM" v-else class="h-4 w-4" />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 :class="[
                    'font-medium text-sm',
                    meetingCreation.state.currentStep === 3 ? 'text-primary' : ''
                  ]">
                    {{ $t('Darbotvarkė') }}
                  </h3>
                  <p v-if="meetingCreation.state.agendaItems.length" class="text-xs text-muted-foreground truncate">
                    {{ meetingCreation.state.agendaItems.length }} {{ $t('klausimai') }}
                  </p>
                </div>
              </div>

              <!-- Step 4 -->
              <div v-if="!isQuickMode" class="flex items-start gap-3 cursor-pointer" @click="handleStepClick(4)">
                <div :class="[
                  'flex-shrink-0 w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all',
                  meetingCreation.state.currentStep === 4
                    ? 'bg-primary border-primary text-primary-foreground'
                    : 'border-muted-foreground/30 text-muted-foreground'
                ]">
                  <CheckCircle class="h-4 w-4" />
                </div>
                <div class="flex-1 min-w-0">
                  <h3 :class="[
                    'font-medium text-sm',
                    meetingCreation.state.currentStep === 4 ? 'text-primary' : ''
                  ]">
                    {{ $t('Peržiūra') }}
                  </h3>
                  <p class="text-xs text-muted-foreground truncate">
                    {{ $t('Patikrinkite informaciją prieš kūrimą') }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step Content -->
        <div class="flex-1 min-h-[400px]">
          <Suspense>
            <FadeTransition :key="meetingCreation.state.currentStep" mode="out-in">
              <InstitutionSelectorForm v-if="meetingCreation.state.currentStep === 1"
                :selected-institution="meetingCreation.state.institution"
                @submit="handleInstitutionSelect" />
              <MeetingDetailsForm v-else-if="meetingCreation.state.currentStep === 2"
                :meeting="meetingCreation.state.meeting"
                :institution-id="meetingCreation.state.institution?.id"
                :loading="meetingCreation.state.loading.validation"
                :meeting-types="meetingTypes"
                @submit="handleMeetingFormSubmit" />
              <AgendaItemsForm v-else-if="meetingCreation.state.currentStep === 3"
                :loading="meetingCreation.state.loading.submission"
                :institution-id="meetingCreation.state.institution?.id"
                :agenda-items="meetingCreation.state.agendaItems"
                :recent-meetings="props.recentMeetings"
                @submit="handleAgendaItemsFormSubmit" />
              <MeetingReviewForm v-else-if="meetingCreation.state.currentStep === 4"
                :loading="meetingCreation.state.loading.submission" 
                :meeting-state="meetingCreation.state"
                @edit-step="meetingCreation.goToStep"
                @back="meetingCreation.previousStep" 
                @submit="handleFinalSubmit" />
            </FadeTransition>
            <template #fallback>
              <div class="flex items-center justify-center h-64">
                <Loader2 class="h-6 w-6 animate-spin text-muted-foreground" />
              </div>
            </template>
          </Suspense>
        </div>
      </div>
    </DialogContent>
  </Dialog>
</template>

<script setup lang="ts">
import { trans as $t } from "laravel-vue-i18n";
import { computed, watch, ref, onMounted } from "vue";
import { usePage } from "@inertiajs/vue3";
import { CheckCircle, Loader2 } from "lucide-vue-next";
import { useFetch } from "@vueuse/core";

import { useMeetingCreation } from "@/Composables/useMeetingCreation";
import AgendaItemsForm from "@/Components/AdminForms/Special/AgendaItemsForm.vue";
import MeetingDetailsForm from "@/Components/AdminForms/MeetingDetailsForm.vue";
import MeetingReviewForm from "@/Components/AdminForms/MeetingReviewForm.vue";
import InstitutionSelectorForm from "@/Components/AdminForms/Special/InstitutionSelectorForm.vue";
import FadeTransition from "@/Components/Transitions/FadeTransition.vue"
import Icons from "@/Types/Icons/filled";
// Import Shadcn components
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/Components/ui/dialog";

// Import Lucide icons

const emit = defineEmits<(e: 'close') => void>();

const props = defineProps<{
  institution?: App.Entities.Institution;
  showModal: boolean;
  suggestedAt?: Date | string;
  recentMeetings?: Array<{ id: string; title: string; start_time: string; institution_name: string; agenda_items: { title: string }[] }>;
}>();

// Meeting types state
const meetingTypes = ref<Array<{ id: number, title: string, model_type: string }>>([]);
const isLoadingTypes = ref(true);

// Initialize meeting creation composable
const meetingCreation = useMeetingCreation({
  preSelectedInstitution: props.institution,
  mode: 'detailed',
  onSuccess: (meeting) => {
    // Navigate to the created meeting and close modal
    emit('close');
  },
  onError: (errors) => {
    console.error('Meeting creation failed:', errors);
  }
});

// If a suggested date is passed, seed the meeting start_time once modal is shown
const seedFromProps = () => {
  if (!props.showModal) return
  
  if (props.institution) {
    meetingCreation.updateInstitution(props.institution)
    // Auto-navigate to step 2 when institution is provided
    meetingCreation.goToStep(2)
  }
  
  if (props.suggestedAt) {
    const dt = typeof props.suggestedAt === 'string' ? new Date(props.suggestedAt) : props.suggestedAt
    if (!Number.isNaN(dt?.getTime?.())) {
      meetingCreation.updateMeetingData({ start_time: dt.toISOString?.() ?? String(dt) })
      // Avoid showing early validation errors before user interacts
      meetingCreation.clearAllErrors()
    }
  }
}

watch([() => props.showModal, () => props.institution, () => props.suggestedAt], () => {
  seedFromProps()
}, { immediate: true })

// Computed properties
// Force detailed flow only
const isQuickMode = computed(() => false);
const totalSteps = computed(() => 4);
const loading = computed(() => meetingCreation.state.loading.submission);

// Methods
const handleDialogClose = () => {
  if (!loading.value) {
    emit('close');
  }
};

// Mode switching removed (detailed-only)

const handleStepClick = (step: number) => {
  if (loading.value) return;
  meetingCreation.goToStep(step);
};

const handleInstitutionSelect = (institutionId: string) => {
  // Find the full institution object
  const duties = usePage().props.auth?.user?.current_duties || [];
  const duty = duties.find((d: any) => String(d.institution?.id) === String(institutionId));
  let institution = duty?.institution;

  // Fallback for admins/all-scope: search providedTenant institutions
  if (!institution) {
    const provided = (usePage().props as any)?.providedTenant?.institutions || [];
    institution = provided.find((i: any) => String(i?.id) === String(institutionId));
  }

  if (institution) {
    meetingCreation.updateInstitution(institution);
    meetingCreation.nextStep();
  }
};

const handleMeetingFormSubmit = (meetingData: any) => {
  meetingCreation.updateMeetingData(meetingData);

  meetingCreation.nextStep(); // Go to agenda step
};

const handleAgendaItemsFormSubmit = (agendaData: any) => {
  const agendaItems = (agendaData.agendaItemTitles || []).map((title: string, index: number) => ({
    title,
    description: '',
    order: index + 1
  }));

  meetingCreation.updateAgendaItems(agendaItems);
  meetingCreation.nextStep(); // Go to review step
};

const handleFinalSubmit = () => {
  meetingCreation.submitMeeting();
};

// Helper methods for stepper display
const formatMeetingTime = (): string => {
  const startTime = meetingCreation.state.meeting.start_time;
  if (!startTime) return '';

  const date = new Date(startTime);
  return date.toLocaleString(undefined, {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit'
  });
};

const getAgendaSummary = (): string => {
  const items = meetingCreation.state.agendaItems;
  if (items.length === 0) return '';
  if (items.length === 1) return '1 klausimas';
  return `${items.length} klausimai`;
};

const getMeetingTypeName = (): string => {
  const typeId = meetingCreation.state.meeting.type_id;
  if (!typeId) return '';

  // Use the fetched meeting types
  const type = meetingTypes.value.find((t: any) => t.id === typeId);

  if (type) {
    return type.title;
  }

  // Fallback - show type ID
  return `${$t('Tipas')}: #${typeId}`;
};

// Fetch meeting types
const fetchMeetingTypes = async () => {
  try {
    isLoadingTypes.value = true;
    const { data, error } = await useFetch(route("api.types.index"), { immediate: true }).get().json()
    if (error.value) throw error.value

    // Ensure data is an array before filtering
    const typesData = Array.isArray(data.value) ? data.value : [];
    meetingTypes.value = typesData.filter((type: any) => type.model_type === "App\\Models\\Meeting");
  } catch (error) {
    console.error('Failed to fetch meeting types:', error);
    meetingTypes.value = [];
  } finally {
    isLoadingTypes.value = false;
  }
};

// Lifecycle
onMounted(() => {
  fetchMeetingTypes();
});
</script>
