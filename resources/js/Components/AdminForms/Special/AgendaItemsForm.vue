<template>
  <div class="flex flex-col gap-6">
    <FadeTransition>
      <SuggestionAlert :show-alert @alert-closed="showAlert = false">
        <template v-if="$page.props.app.locale === 'lt'">
          <p class="mt-0">
            <span>Kiekvienas posėdis turi</span>
            <ModelChip>
              <template #icon>
                <component :is="IconsRegular.AGENDA_ITEM" class="h-4 w-4" />
              </template>
              darbotvarkės klausimų
            </ModelChip>
          </p>
          <p class="mb-4">
            Įrašyk arba įkopijuok visus klausimus, kurie šiuo metu yra numatomi
            posėdyje. Galite naudoti šablonus greičiau kūrimui.
          </p>
        </template>
        <template v-else>
          <p class="mt-0">
            <span>Each meeting has</span>
            <ModelChip>
              <template #icon>
                <component :is="IconsRegular.AGENDA_ITEM" class="h-4 w-4" />
              </template>
              agenda items
            </ModelChip>
          </p>
          <p class="mb-4">
            Enter or paste all the questions that are currently planned for the
            meeting. You can use templates for faster creation.
          </p>
        </template>
      </SuggestionAlert>
    </FadeTransition>

    <!-- Templates Section -->
    <div v-if="availableTemplates.length > 0" class="space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-sm font-medium text-muted-foreground">
          {{ $t('Šablonai') }}
        </h3>
        <Button type="button" variant="ghost" size="sm" @click="showTemplates = !showTemplates">
          {{ showTemplates ? $t('Slėpti') : $t('Rodyti šablonus') }}
          <ChevronDown class="ml-1 h-3 w-3" :class="{ 'rotate-180': showTemplates }" />
        </Button>
      </div>

      <Collapsible v-model:open="showTemplates">
        <CollapsibleContent class="space-y-3">
          <!-- Quick Templates -->
          <div v-if="quickTemplates.length > 0" class="space-y-2">
            <p class="text-xs text-muted-foreground">
              {{ $t('Greiti šablonai') }}
            </p>
            <div class="flex flex-wrap gap-2">
              <Button v-for="template in quickTemplates" :key="template.id" type="button" variant="secondary" size="sm"
                @click="applyQuickTemplate(template.id)">
                <LayoutTemplate class="mr-2 h-3 w-3" />
                {{ template.name }}
              </Button>
            </div>
          </div>

          <!-- Recent Templates -->
          <div v-if="recentTemplates.length > 0" class="space-y-2">
            <p class="text-xs text-muted-foreground">
              {{ $t('Paskutiniai susitikimai') }}
            </p>
            <div class="space-y-1">
              <Button v-for="template in recentTemplates" :key="template.id" type="button" variant="ghost" size="sm"
                class="justify-start h-auto p-2 w-full" @click="applyFullTemplate(template.id)">
                <div class="flex items-center gap-2 w-full text-left">
                  <History class="h-3 w-3 flex-shrink-0" />
                  <div class="flex-1 min-w-0">
                    <p class="text-sm truncate">
                      {{ template.name }}
                    </p>
                    <p class="text-xs text-muted-foreground">
                      {{ template.agendaItems.length }} {{ $t('klausimai') }}
                    </p>
                  </div>
                </div>
              </Button>
            </div>
          </div>
        </CollapsibleContent>
      </Collapsible>

      <Separator />
    </div>

    <Form v-slot="{ values }" :validation-schema="schema" :initial-values="initialValues.value" @submit="onSubmit">
      <div class="space-y-6">
        <FormField ref="agendaItemField" v-slot="{ componentField, setValue }" name="agendaItemTitles">
          <FieldArray v-slot="{ fields, remove, push, move }" name="agendaItemTitles">
            <FormItem>
              <FormLabel class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <component :is="IconsFilled.AGENDA_ITEM" class="h-4 w-4" />
                  {{ $t("Darbotvarkės klausimai") }}
                </div>
                <div class="text-xs text-muted-foreground">
                  {{ fields.length }} {{ $t('klausimai') }}
                  <span v-if="estimatedDuration">• {{ estimatedDuration }} {{ $t('min.') }}</span>
                </div>
              </FormLabel>

              <div class="flex flex-col gap-4">
                <!-- Individual items input with drag and drop -->
                <div v-if="!showQuestionInputInTextArea && fields.length > 0" class="space-y-2">
                  <TransitionGroup name="list" tag="div">
                    <div v-for="(field, index) in fields" :key="field.key"
                      class="flex items-start gap-2 p-2 rounded-lg border border-dashed hover:border-solid hover:bg-muted/50 transition-all"
                      :draggable="true" @dragstart="handleDragStart(index)" @dragover="handleDragOver"
                      @drop="handleDrop(index, move)">
                      <GripVertical class="h-4 w-4 mt-2 text-muted-foreground cursor-grab active:cursor-grabbing" />
                      <span class="w-7 flex-shrink-0 mt-2 text-sm font-medium text-muted-foreground">{{ `${index + 1}.`
                      }}</span>
                      <div class="flex-1 space-y-2">
                        <FormControl>
                          <Input v-model="(field as any).value" :placeholder="`Darbotvarkės klausimas nr. ${index + 1}`"
                            @keydown.enter.prevent="addNewItem(index + 1, push)"
                            @keydown.backspace="handleBackspace(index, (field as any).value, remove)" />
                        </FormControl>
                        <!-- Optional description for agenda items -->
                        <FormControl v-if="showDescriptions">
                          <Textarea v-model="(field as any).description"
                            :placeholder="$t('Papildomas aprašymas (neprivalomas)')" class="text-sm resize-none"
                            :rows="2" />
                        </FormControl>
                      </div>
                      <div class="flex items-center gap-1 mt-2">
                        <Button type="button" variant="ghost" size="icon" class="h-6 w-6 opacity-50 hover:opacity-100"
                          @click="duplicateItem(index, (field as any).value, push)">
                          <Copy class="h-3 w-3" />
                        </Button>
                        <Button type="button" variant="ghost" size="icon"
                          class="h-6 w-6 opacity-50 hover:opacity-100 hover:text-destructive" @click="remove(index)">
                          <TrashIcon class="h-3 w-3" />
                        </Button>
                      </div>
                    </div>
                  </TransitionGroup>

                  <!-- Action buttons - only when there are items -->
                  <div class="flex flex-wrap gap-2 pt-2">
                    <Button type="button" variant="outline" size="sm" @click="push('')">
                      <PlusIcon class="mr-2 h-4 w-4" />
                      {{ $t("Pridėti klausimą") }}
                    </Button>

                    <Button type="button" variant="secondary" size="sm" class="border"
                      @click="showDescriptions = !showDescriptions">
                      <DocumentIcon class="mr-2 h-4 w-4" />
                      {{ showDescriptions ? $t('Slėpti aprašymus') : $t('Rodyti aprašymus') }}
                    </Button>

                    <Button type="button" variant="outline" size="sm"
                      @click="showQuestionInputInTextArea = true">
                      <DocumentIcon class="mr-2 h-4 w-4" />
                      {{ $t('Įkelti iš teksto') }}
                    </Button>
                  </div>
                </div>

                <!-- Text area input -->
                <div v-else class="space-y-4">
                  <div class="flex items-center justify-between">
                    <h4 class="font-medium">
                      {{ $t('Masinis klausimų įvedimas') }}
                    </h4>
                    <Button type="button" size="sm" variant="outline" @click="showQuestionInputInTextArea = false">
                      <ArrowLeft class="mr-2 h-3 w-3" />
                      {{ $t('Grįžti') }}
                    </Button>
                  </div>

                  <FormControl>
                    <Textarea v-model="questionInputInTextArea"
                      :placeholder="$page.props.app.locale === 'lt' ? 'Kiekvienas klausimas turi būti iš naujos eilutės, pvz.:\n\n1. Praėjusio posėdžio protokolo tvirtinimas\n2. Einamųjų reikalų aptarimas\n3. Ateities planų pristatymas\n4. Kiti klausimai' : 'Every question must begin from new line, e.g.\n\n1. Previous meeting protocol approval\n2. Current affairs discussion\n3. Future plans presentation\n4. Other questions'"
                      class="w-full font-mono text-sm" :rows="8" />
                  </FormControl>

                  <div class="flex items-center justify-between">
                    <div class="text-xs text-muted-foreground">
                      {{ $t('Aptikta') }}: {{ getLineCount(questionInputInTextArea) }} {{ $t('eilutės') }}
                    </div>
                    <Button type="button" @click="handleQuestionsFromTextArea">
                      <Upload class="mr-2 h-4 w-4" />
                      {{ $t('Įkelti klausimus') }}
                    </Button>
                  </div>
                </div>

                <!-- Skip option for optional agenda -->
                <div v-if="fields.length === 0 && !showQuestionInputInTextArea"
                  class="text-center py-8 border border-dashed rounded-lg">
                  <component :is="IconsRegular.AGENDA_ITEM" class="h-8 w-8 mx-auto text-muted-foreground/50 mb-3" />
                  <p class="text-sm text-muted-foreground mb-4">
                    {{ $t('Darbotvarkės klausimai yra neprivalomi') }}
                  </p>
                  <div class="flex items-center justify-center gap-2">
                    <Button type="button" variant="outline" size="sm" @click="showQuestionInputInTextArea = true">
                      <DocumentIcon class="mr-2 h-4 w-4" />
                      {{ $t('Įkelti iš teksto') }}
                    </Button>
                    <Button type="button" variant="outline" size="sm" @click="push('')">
                      <PlusIcon class="mr-2 h-4 w-4" />
                      {{ $t('Pridėti klausimą') }}
                    </Button>
                  </div>
                </div>
              </div>
              <FormMessage />
            </FormItem>
          </FieldArray>
        </FormField>

        <!-- Action buttons -->
        <div class="flex items-center justify-between pt-4 border-t">
          <div class="flex items-center gap-2">
            <Button v-if="currentFieldCount > 0" type="button" variant="ghost" size="sm" @click="clearAllItems">
              <Trash2 class="mr-2 h-3 w-3" />
              {{ $t('Išvalyti visus') }}
            </Button>
          </div>

          <div class="flex items-center gap-2">
            <TooltipProvider v-if="currentFieldCount === 0">
              <Tooltip>
                <TooltipTrigger as-child>
                  <Button type="button" variant="outline" @click="skipAgenda">
                    {{ $t('Praleisti darbotvarkę') }}
                  </Button>
                </TooltipTrigger>
                <TooltipContent>
                  {{ $t('Darbotvarkę galėsite pridėti vėliau') }}
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>

            <Button type="submit" :disabled="loading">
              <span v-if="loading">
                <Loader2 class="mr-2 h-4 w-4 animate-spin" />
                {{ $t('Kuriama...') }}
              </span>
              <span v-else>
                {{ $t("Sukurti susitikimą") }}
                <CheckCircle class="ml-2 h-4 w-4" />
              </span>
            </Button>
          </div>
        </div>
      </div>
    </Form>
  </div>
</template>

<script setup lang="ts">
import { ref, useTemplateRef, computed, onMounted, onUnmounted, watch } from "vue";
import { trans as $t } from "laravel-vue-i18n";
import { Form, FieldArray } from "vee-validate";
import { toTypedSchema } from '@vee-validate/zod';
import * as z from 'zod';
import {
  Trash as TrashIcon,
  Plus as PlusIcon,
  FileText as DocumentIcon,
  LayoutTemplate,
  ArrowRight,
  History,
  ChevronDown,
  GripVertical,
  Copy,
  ArrowLeft,
  Upload,
  Trash2,
  CheckCircle,
  Loader2,
} from "lucide-vue-next";

import FadeTransition from "@/Components/Transitions/FadeTransition.vue";
import IconsFilled from "@/Types/Icons/filled";
import IconsRegular from "@/Types/Icons/regular";
import ModelChip from "@/Components/Tag/ModelChip.vue";
import SuggestionAlert from "@/Components/Alerts/SuggestionAlert.vue";
import { useMeetingTemplates } from "@/Composables/useMeetingTemplates";
// Import Shadcn components
import { Button } from "@/Components/ui/button";
import { Input } from "@/Components/ui/input";
import { Textarea } from "@/Components/ui/textarea";
import { Separator } from "@/Components/ui/separator";
import {
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/Components/ui/form";
import { Collapsible, CollapsibleContent, } from "@/Components/ui/collapsible";
// Import Lucide icons
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/Components/ui/tooltip";

const emit = defineEmits<(e: "submit", data: Record<string, any>) => void>();

const props = defineProps<{
  loading: boolean;
  institutionId?: string;
  agendaItems?: Array<{ title: string; description?: string; order: number }>;
  recentMeetings?: Array<{ id: string; title: string; start_time: string; institution_name: string; agenda_items: { title: string }[] }>;
}>();

// Composables
const {
  templates,
  quickAgendaTemplates,
  getTemplatesForInstitution,
  loadRecentMeetings,
  applyTemplate,
  suggestMeetingDuration
} = useMeetingTemplates(props.recentMeetings);

const agendaItemField = useTemplateRef<typeof FormField>("agendaItemField");

// Local state
const showAlert = ref(true);
const showQuestionInputInTextArea = ref(false);
const showTemplates = ref(false);
const showDescriptions = ref(false);
const questionInputInTextArea = ref("");
const draggedIndex = ref<number | null>(null);
const estimatedDuration = ref<number | null>(null);

// Computed properties
const availableTemplates = computed(() => {
  if (!props.institutionId) return templates.value.filter(t => t.isDefault);
  return getTemplatesForInstitution({ id: props.institutionId } as App.Entities.Institution);
});

const quickTemplates = computed(() => quickAgendaTemplates.value);

const fullTemplates = computed(() =>
  availableTemplates.value.filter(t => t.type === 'standard')
);

const recentTemplates = computed(() =>
  availableTemplates.value.filter(t => t.type === 'recent').slice(0, 3)
);

const currentAgendaItems = computed(() =>
  props.agendaItems?.map(item => item.title) || []
);

// Track the current field count for use outside FieldArray scope
const currentFieldCount = ref(0);

// Create a reactive way to track form field count
const getFormFieldCount = () => {
  const form = agendaItemField.value?.$el?.closest('form');
  if (form) {
    const inputs = form.querySelectorAll('input[placeholder*="Darbotvarkės klausimas"]');
    return inputs.length;
  }
  return 0;
};

// Define validation schema using zod
const schema = toTypedSchema(z.object({
  agendaItemTitles: z.array(z.string())
    .refine(items => {
      // If there are items, they must not be empty or whitespace-only
      // Allow empty array (agenda is optional)
      return items.length === 0 || items.every(item => item && item.trim().length > 0);
    }, { message: $t("Klausimas negali būti tuščias") }),
}));

// Set initial values from props
const initialValues = computed(() => ({
  agendaItemTitles: currentAgendaItems.value,
}));

// Template methods
const getTemplateIcon = (type: string) => {
  switch (type) {
    case 'recent':
      return History;
    case 'custom':
      return DocumentIcon;
    default:
      return LayoutTemplate;
  }
};

const applyQuickTemplate = (templateId: string) => {
  const template = quickTemplates.value.find(t => t.id === templateId);
  if (template && agendaItemField.value) {
    agendaItemField.value.setValue(template.items);
    showTemplates.value = false;
    updateEstimatedDuration(template.items.length);
  }
};

const applyFullTemplate = (templateId: string) => {
  const items = applyTemplate(templateId);
  if (items.length > 0 && agendaItemField.value) {
    agendaItemField.value.setValue(items.map(item => item.title));
    showTemplates.value = false;
    updateEstimatedDuration(items.length);
  }
};

// Form interaction methods
const addNewItem = (index: number, push: Function) => {
  push('');
  // Focus on the new item after it's added
  setTimeout(() => {
    const inputs = document.querySelectorAll('input[placeholder*="Darbotvarkės klausimas"]');
    const newInput = inputs[index] as HTMLInputElement;
    newInput?.focus();
  }, 100);
};

const handleBackspace = (index: number, value: string, remove: Function) => {
  if (value === '' && index > 0) {
    remove(index);
    // Focus on previous item
    setTimeout(() => {
      const inputs = document.querySelectorAll('input[placeholder*="Darbotvarkės klausimas"]');
      const prevInput = inputs[index - 1] as HTMLInputElement;
      prevInput?.focus();
    }, 100);
  }
};

const duplicateItem = (index: number, value: string, push: Function) => {
  push(value);
};

const clearAllItems = () => {
  if (agendaItemField.value) {
    agendaItemField.value.setValue([]);
    estimatedDuration.value = null;
  }
};

// Drag and drop methods
const handleDragStart = (index: number) => {
  draggedIndex.value = index;
};

const handleDragOver = (event: DragEvent) => {
  event.preventDefault();
};

const handleDrop = (targetIndex: number, move: Function) => {
  if (draggedIndex.value !== null && draggedIndex.value !== targetIndex) {
    move(draggedIndex.value, targetIndex);
  }
  draggedIndex.value = null;
};

// Text area methods
const getLineCount = (text: string): number => {
  return text.split('\n').filter(line => line.trim() !== '').length;
};

const handleQuestionsFromTextArea = () => {
  const questions = questionInputInTextArea.value
    .split('\n')
    .map(q => q.trim().replace(/^\d+\.\s*/, '')) // Remove numbering like "1. "
    .filter(q => q !== '');

  if (questions.length > 0) {
    agendaItemField.value?.setValue(questions);
    showQuestionInputInTextArea.value = false;
    updateEstimatedDuration(questions.length);
  }
};

// Utility methods
const updateEstimatedDuration = (itemCount: number) => {
  estimatedDuration.value = suggestMeetingDuration(itemCount);
};

const skipAgenda = () => {
  // Submit with empty agenda
  const formData = {
    agendaItemTitles: [],
  };

  emit("submit", formData);
};

// Submit form handler
const onSubmit = (values: any) => {
  const formData = {
    agendaItemTitles: values.agendaItemTitles.filter((item: string) => item.trim() !== ''),
  };

  emit("submit", formData);
};

// Watch for field count changes
watch(() => currentAgendaItems.value, (newItems) => {
  currentFieldCount.value = newItems.length;
  if (newItems.length > 0) {
    updateEstimatedDuration(newItems.length);
  }
}, { immediate: true });

// Watch for changes in form state to update field count
let fieldCountUpdateInterval: NodeJS.Timeout;
onMounted(() => {
  // Use a simple interval to check field count changes
  fieldCountUpdateInterval = setInterval(() => {
    if (agendaItemField.value) {
      const form = agendaItemField.value.$el?.closest('form');
      if (form) {
        const inputs = form.querySelectorAll('input[placeholder*="Darbotvarkės klausimas"]');
        const newCount = inputs.length;
        if (newCount !== currentFieldCount.value) {
          currentFieldCount.value = newCount;
          if (newCount > 0) {
            updateEstimatedDuration(newCount);
          }
        }
      }
    }
  }, 100); // Check every 100ms
});

onUnmounted(() => {
  if (fieldCountUpdateInterval) {
    clearInterval(fieldCountUpdateInterval);
  }
});

// Lifecycle
onMounted(async () => {
  // Load recent meetings if institution is provided
  if (props.institutionId) {
    await loadRecentMeetings(props.institutionId);
  }
});
</script>

<style scoped>
/* Transition styles for drag and drop */
.list-move,
.list-enter-active,
.list-leave-active {
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.list-enter-from,
.list-leave-to {
  opacity: 0;
  transform: translateX(-10px);
}

.list-leave-active {
  position: absolute;
  right: 0;
  left: 0;
}
</style>
